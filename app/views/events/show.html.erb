<body class="body-show">

<% if user_signed_in? == false %>

  <div class="container-show">
    <div class="card-beg">

     <div class="photo-card">
        <%= image_tag "#{@event.photo}" %>

        <div class="avatar-show">
        <%# Displaying avatar or default avatar %>
          <% if @event.host.photo.key %>
            <%= cl_image_tag @event.host.photo.key, class: 'image-avatar-show' %>
          <% else %>
            <%= image_tag "kitten.jpg", class: 'image-avatar-show' %>
          <% end %>


          <div class="profile-show-card">
            <ul>
              <%= @event.host.first_name %>
              <%= @event.host.last_name %> |
              <div class="pink">
                <i class="fa-solid fa-bullseye"></i> <%= @event.host.level %>
              </div>
            </ul>
          </div>
        </div>

      </div>

      <div class="photo-card-text">

        <div class="header-show">
          <div class="left-header-show">
            <div class="left-in-left">
              <div class="icon-participants"><i class="fa-solid fa-user-group"></i></div>
              <div class="text-participant"><p><%= @event.bookings.count %> participants</p></div>
            </div>

            <div class="right-in-left">
              <div class="icon-price"><i class="fa-solid fa-wine-bottle"></i></div>
              <div class="price-text"><p><%= @event.min_price %>€ à <%= @event.max_price %>€</p></div>
            </div>
          </div>

          <div class="right-header-show">
            <p class= "pink date-show"><%= @event.date.to_fs(:rfc822)  %></p>
            <p class="bold "><%= @event.category%></p>
          </div>
        </div>

          <%# <div class="address-event">
            <i class="fa-solid fa-location-dot"></i>
            <p><%= @event.city %>
            <%# <p><%= @event.region %>
          <%# </div> %>
      </div>

    </div>

    <div class="border-bottom"></div>

    <div class="description">
      <p class="bold">Description</p>
      <p class= "event-name"><%= @event.name %></p>
      <p><%= @event.city %><p><%= @event.region %>
      <p><%= @event.description %></p>
    </div>

    <%= link_to "Login", new_user_session_path, class: "button-index-create" %>

      <% else %>

    <div class="container-show">
    <div class="card-beg">

     <div class="photo-card">
        <%= image_tag "#{@event.photo}" %>

        <div class="avatar-show">
        <%# Displaying avatar or default avatar %>
          <% if @event.host.photo.key %>
            <%= cl_image_tag @event.host.photo.key, class: 'image-avatar-show' %>
          <% else %>
            <%= image_tag "kitten.jpg", class: 'image-avatar-show' %>
          <% end %>


          <div class="profile-show-card">
            <ul>
              <%= @event.host.first_name %>
              <%= @event.host.last_name %> |
              <div class="pink">
                <i class="fa-solid fa-bullseye"></i> <%= @event.host.level %>
              </div>
            </ul>
          </div>
        </div>

      </div>

      <div class="photo-card-text">

        <div class="header-show">
          <div class="left-header-show">
            <div class="left-in-left">
              <div class="icon-participants"><i class="fa-solid fa-user-group"></i></div>
              <div class="text-participant"><p><%= @event.bookings.count %> participants</p></div>
            </div>

            <div class="right-in-left">
              <div class="icon-price"><i class="fa-solid fa-wine-bottle"></i></div>
              <div class="price-text"><p><%= @event.min_price %>€ à <%= @event.max_price %>€</p></div>
            </div>
          </div>

          <div class="right-header-show">
            <p class= "pink date-show"><%= @event.date.to_fs(:rfc822)  %></p>
            <p class="bold "><%= @event.category%></p>
          </div>
        </div>

          <%# <div class="address-event">
            <i class="fa-solid fa-location-dot"></i>
            <p><%= @event.city %>
            <%# <p><%= @event.region %>
          <%# </div> %>
      </div>

    </div>

    <div class="border-bottom"></div>

    <div class="description">
      <p class="bold">Description</p>
      <p class= "event-name"><%= @event.name %></p>
      <p><%= @event.city %><p><%= @event.region %>
      <p><%= @event.description %></p>
    </div>

    <div class="border-bottom"></div>

    <p class="titre-participant-bold">Les participants</p>

    <div class="card-index-list">
      <% @bookings.each do | booking | %>
        <div class="single-card">

          <%# Displaying avatar or default avatar %>
          <% if booking.guest.photo.key %>
            <%= cl_image_tag booking.guest.photo.key, class: 'image-avatar-show' %>
          <% else %>
            <%= image_tag "kitten.jpg", class: 'image-avatar-show' %>
          <% end %>


          <div class="card-index-list-text">
            <ul>
              <%= booking.guest.first_name %>
              <%= booking.guest.last_name %> |
              <div class="pink"><i class="fa-solid fa-bullseye"></i> <%= booking.guest.level %></div>
            </ul>
          </div>
          <p> Apportera : <span><%= booking.comment %></span></p>
        </div>
      <% end %>
    </div>

    <div class="border-bottom"></div>


    <div class="map-show">
      <div class="map-card">
        <div style="width: 100%; height: 300px;"
          data-controller="map"
          data-map-marker-value="<%= @marker.to_json %>"
          data-map-api-key-value="<%= ENV['MAPBOX_API_KEY'] %>">
        </div>
      </div>
    </div>

    <div class="js-fun">
      <%# Si on est host, on voit un bouton Modifier %>
      <% if @event.host == current_user %>
        <%= link_to "Modifier", edit_host_event_path(@event) %>

      <%# Si on est pas host, mais qu'on est déjà un guest, on voit un bouton "Je ne viens plus" %>
      <% elsif @event.guests.include?(current_user) %>
        <div class="dont-come">
          <%= link_to "Je ne viens plus",
            event_booking_path(@event),
            data: {turbo_method: :delete}
          %>
        </div>
      <%# Si on n'est ni host ni guest, on voit un bouton Participer %>
      <% else %>

        <div class="participer-show" data-controller="edit">
          <%#= 1er boutton %>
          <div class="interesse-show">
            <p data-action="click->edit#displayForm">Je voudrais participer</p>
            <i class="fa-solid fa-caret-down"></i>
          </div>

          <%#= Boutton dynamique %>
          <div class="d-none interesse-show2" data-edit-target="content">
            <%= simple_form_for [@event, @booking], html: { novalidate: false } do |f| %>
              <%= f.error_notification %>
              <div class="form-login">
                <%= f.input :comment,
                            label: false,
                            input_html: { placeholder: "Dis nous le nectar de ton choix" }%>
              </div>
              <div class="btn-interesse-show">
                <%= f.submit "Participer", class: "btn" %>
                <p data-action="click->edit#undisplayForm">Retour</p>
              </div>
            <% end %>
          </div>
        </div>

      <% end %>
    </div>

    <div class="border-bottom"></div>

    <%# chat begins here %>
      <% if @event.host == current_user || @event.guests.include?(current_user) %>

        <h2 class="text-center">Messages</h2>

        <div class="container chatroom" data-controller="chatroom-subscription" data-chatroom-subscription-chatroom-id-value="<%= @chatroom.id %>"data-chatroom-subscription-current-user-id-value="<%= current_user.id %>">

          <%# Existing messages %>

          <div class="messages" data-chatroom-subscription-target="messages">
            <% @chatroom.messages.each do |message| %>
              <div class="message-row d-flex <%= message.sender?(current_user) ? 'justify-content-end' : 'justify-content-start' %>">
                <div class="<%= message.sender?(current_user) ? 'sender-style  bubble-bottom-right' : 'receiver-style  bubble-bottom-left' %>">
                  <%= render "messages/message", message: message %>
                </div>
              </div>
            <% end %>
          </div>



          <%# Form %>

          <%= simple_form_for [@event, @chatroom, @message],
            html: { data: { action: "turbo:submit-end->chatroom-subscription#resetForm" }, class: "d-flex" } do |f|
          %>
            <%= f.input :content,
              label: false,
              placeholder: "Votre message",
              wrapper_html: {class: "flex-grow-1"}
            %>
            <%= f.submit "Envoyer", class: "btn btn-primary mb-3" %>
          <% end %>
        </div>

      <% end %>
    <%# chat ends here %>

  </div>

<% end %>
</body>
